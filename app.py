# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1U6WD5A-bvWqPlW8_Z1xZ9QG9DkF00Q_s
"""

import streamlit as st
import pandas as pd
import plotly.express as px

st.set_page_config(page_title="Dashboard Sabda Tani", layout="wide")

# ================================
# LOAD CUSTOM CSS
# ================================
with open("sabdatani.css") as f:
    st.markdown(f"<style>{f.read()}</style>", unsafe_allow_html=True)

# ================================
# LOAD DATA EXCEL (MASTER)
# ================================
@st.cache_data
def load_excel():
    df_raw = pd.read_excel("data1.xlsx", header=None)

    # Kolom A = Kecamatan
    kecamatan_series = df_raw.iloc[:, 0].dropna().reset_index(drop=True)

    # Kolom Bâ€“M = Desa
    desa_df = df_raw.iloc[:, 1:13]

    # Kolom Nâ€“GC = Gapoktan
    gap_df = df_raw.iloc[:, 13: ]

    data_list = []

    for i, kec in kecamatan_series.items():
        # Ambil desa di baris yang sama
        desa_row = desa_df.iloc[i].dropna().tolist()

        for desa in desa_row:
            # Ambil gapoktan untuk desa ini (baris i)
            gap_list = gap_df.iloc[i].dropna().tolist()

            for gap in gap_list:
                data_list.append([kec, desa, gap])

    df_final = pd.DataFrame(data_list, columns=["Kecamatan", "Desa", "Gapoktan"])

    # ================================
    # CLEANING PREMIUM
    # ================================
    df_final = df_final.dropna(subset=["Kecamatan"])
    df_final = df_final[df_final["Desa"].notna() & (df_final["Desa"] != "")]
    df_final = df_final[df_final["Gapoktan"].notna() & (df_final["Gapoktan"] != "")]
    df_final = df_final.reset_index(drop=True)

    return df_final

df = load_excel()

# ================================
# DASHBOARD TITLE
# ================================
st.markdown("""
<h1 class='title-main'>ðŸŒ¾ Dashboard Sabda Tani â€“ Gapoktan Pacitan</h1>
""", unsafe_allow_html=True)

# ================================
# KARTU STATISTIK
# ================================
col1, col2, col3 = st.columns(3)

with col1:
    st.markdown(f"""
    <div class='card'>
        <h3>Total Kecamatan</h3>
        <p>{df['Kecamatan'].nunique()}</p>
    </div>
    """, unsafe_allow_html=True)

with col2:
    st.markdown(f"""
    <div class='card'>
        <h3>Total Desa</h3>
        <p>{df['Desa'].nunique()}</p>
    </div>
    """, unsafe_allow_html=True)

with col3:
    st.markdown(f"""
    <div class='card'>
        <h3>Total Gapoktan</h3>
        <p>{df['Gapoktan'].nunique()}</p>
    </div>
    """, unsafe_allow_html=True)

st.markdown("<br>", unsafe_allow_html=True)

# ================================
# MENU FILTER
# ================================
st.subheader("ðŸ”Ž Eksplorasi Data")

menu = st.selectbox(
    "Pilih Mode Tampilan",
    ["Per Kecamatan", "Per Desa", "Per Gapoktan"]
)

# ================================
# 1) PER KECAMATAN
# ================================
if menu == "Per Kecamatan":
    st.subheader("ðŸ“Š Jumlah Gapoktan per Kecamatan")

    gap_kec = df.groupby("Kecamatan").size().reset_index(name="Jumlah")
    gap_kec = gap_kec.sort_values("Kecamatan")

    fig = px.bar(
        gap_kec,
        x="Kecamatan",
        y="Jumlah",
        color="Jumlah",
        color_continuous_scale="Greens",
        title="Distribusi Gapoktan per Kecamatan",
    )
    st.plotly_chart(fig, use_container_width=True)

# ================================
# 2) PER DESA
# ================================
if menu == "Per Desa":
    st.subheader("ðŸŒ¾ Jumlah Gapoktan per Desa")

    kec_select = st.selectbox("Pilih Kecamatan", df["Kecamatan"].unique())

    desa_filtered = df[df["Kecamatan"] == kec_select]
    desa_count = desa_filtered.groupby("Desa").size().reset_index(name="Jumlah")

    fig = px.bar(
        desa_count,
        x="Desa",
        y="Jumlah",
        color="Jumlah",
        title=f"Gapoktan per Desa â€“ {kec_select}",
        color_continuous_scale="Greens",
    )
    st.plotly_chart(fig, use_container_width=True)
# ============================================================
# 4) GAPOKTAN PER DESA (PARSED FROM COLUMN Nâ€“GC)
# ============================================================
st.subheader("ðŸŒ¿ Nama Gapoktan per Desa")

kec_select2 = st.selectbox("Pilih Kecamatan (Gapoktan per Desa)", df["Kecamatan"].unique(), key="gap1")

# Filter desa sesuai kecamatan
desa_options2 = df[df["Kecamatan"] == kec_select2]["Desa"].unique()
desa_select2 = st.selectbox("Pilih Desa", desa_options2, key="gap2")

# Ambil gapoktan sesuai desa
gap_filtered = df[(df["Kecamatan"] == kec_select2) & (df["Desa"] == desa_select2)]

st.markdown(f"### ðŸ“Œ Daftar Gapoktan di **{desa_select2}**, Kecamatan **{kec_select2}**")
st.table(gap_filtered[["Gapoktan"]].reset_index(drop=True))

# ================================
# 3) PER GAPOKTAN
# ================================
if menu == "Per Gapoktan":
    st.subheader("ðŸ“Œ Detail Gapoktan per Desa")

    kec_select = st.selectbox("Pilih Kecamatan", df["Kecamatan"].unique())
    desa_select = st.selectbox("Pilih Desa", df[df["Kecamatan"] == kec_select]["Desa"].unique())

    detail = df[(df["Kecamatan"] == kec_select) & (df["Desa"] == desa_select)]

    st.write(f"### Daftar Gapoktan di **{desa_select}** â€“ Kecamatan **{kec_select}**")
    st.table(detail[["Gapoktan"]].reset_index(drop=True))


# ================================================================
#  EXPORT PDF
# ================================================================
elif menu == "Export PDF":
    st.title("ðŸ“„ Export Laporan Gapoktan")

    pdf_buffer = generate_pdf(df_final)
    b64 = base64.b64encode(pdf_buffer.read()).decode()
    link = f'<a href="data:application/octet-stream;base64,{b64}" download="Laporan_Gapoktan_SabdaTani.pdf">ðŸ“¥ Download PDF</a>'

    st.markdown(link, unsafe_allow_html=True)



