# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1U6WD5A-bvWqPlW8_Z1xZ9QG9DkF00Q_s
"""

import streamlit as st
import pandas as pd
import plotly.express as px

st.set_page_config(page_title="SABDA TANI - Multi Level Dashboard", layout="wide")

# =====================================================
#  LOAD PREMIUM CSS
# =====================================================
with open("sabdatani.css") as f:
    st.markdown(f"<style>{f.read()}</style>", unsafe_allow_html=True)


# =====================================================
#  LOAD DATA EXCEL data1.xlsx
# =====================================================
@st.cache_data
def load_data():
    df_raw = pd.read_excel("data1.xlsx", header=None)

    result = []

    for i, row in df_raw.iterrows():

        kecamatan = str(row.iloc[0]).strip()  # kolom A

        # kolom B‚ÄìM = Desa (12 kolom)
        desa_list = [
            str(x).strip()
            for x in row.iloc[1:13]
            if pd.notna(x) and str(x).strip() != ""
        ]

        # kolom N‚ÄìGC = Gapoktan (semua kolom setelah desa)
        gapoktan_list = [
            str(x).strip()
            for x in row.iloc[13:]
            if pd.notna(x) and str(x).strip() != ""
        ]

        # pairing: desa[i] ‚Üí gapoktan[i]
        for idx, desa in enumerate(desa_list):
            if idx < len(gapoktan_list):
                gap = gapoktan_list[idx]
            else:
                gap = None

            result.append([kecamatan, desa, gap])

    df = pd.DataFrame(result, columns=["Kecamatan", "Desa", "Gapoktan"])

    # CLEANING
    df = df[df["Kecamatan"].notna() & (df["Kecamatan"] != "")]
    df = df[df["Desa"].notna() & (df["Desa"] != "")]
    df = df[df["Gapoktan"].notna() & (df["Gapoktan"] != "")]
    df = df.reset_index(drop=True)

    return df


df = load_data()

# =====================================================
#  TITLE
# =====================================================
st.markdown("""
<h1 class='title-main'>üåæ SABDA TANI ‚Äì Dashboard Multi-Level</h1>
""", unsafe_allow_html=True)


# =====================================================
#  MULTI-LEVEL: KECAMATAN ‚Üí DESA ‚Üí GAPOKTAN
# =====================================================
st.subheader("üîé Drill Down: Kecamatan ‚Üí Desa ‚Üí Gapoktan")

# 1Ô∏è‚É£ PILIH KECAMATAN
kecamatan_select = st.selectbox(
    "Pilih Kecamatan",
    df["Kecamatan"].unique()
)

# 2Ô∏è‚É£ PILIH DESA SESUAI KECAMATAN
desa_select = st.selectbox(
    "Pilih Desa",
    df[df["Kecamatan"] == kecamatan_select]["Desa"].unique()
)

# 3Ô∏è‚É£ TAMPILKAN GAPOKTAN SESUAI DESA
filtered = df[
    (df["Kecamatan"] == kecamatan_select) &
    (df["Desa"] == desa_select)
]

st.markdown(f"""
### üìç Desa: **{desa_select}**  
### üèû Kecamatan: **{kecamatan_select}**
""")

# Display table
st.table(filtered[["Gapoktan"]].reset_index(drop=True))


# =====================================================
#  DISPLAY AS PREMIUM CARDS
# =====================================================
st.markdown("### üåø Daftar Gapoktan")
gap_list = filtered["Gapoktan"].tolist()

cols = st.columns(3)

i = 0
for gap in gap_list:
    with cols[i % 3]:
        st.markdown(
            f"""
            <div class='card'>
                <h3>{gap}</h3>
            </div>
            """,
            unsafe_allow_html=True,
        )
    i += 1


# =====================================================
#  OPTIONAL: GRAFIK PER DESA
# =====================================================
st.markdown("### üìä Grafik Jumlah Gapoktan per Desa (dalam Kecamatan yang Dipilih)")

desa_count = (
    df[df["Kecamatan"] == kecamatan_select]
    .groupby("Desa")
    .size()
    .reset_index(name="Jumlah Gapoktan")
)

fig = px.bar(
    desa_count,
    x="Desa",
    y="Jumlah Gapoktan",
    color="Jumlah Gapoktan",
    color_continuous_scale="Greens",
    title=f"Jumlah Gapoktan di Kecamatan {kecamatan_select}",
)

st.plotly_chart(fig, use_container_width=True)




