# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1U6WD5A-bvWqPlW8_Z1xZ9QG9DkF00Q_s
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import folium
from streamlit_folium import st_folium
from folium.plugins import MarkerCluster
from geopy.geocoders import Nominatim
import base64
from io import BytesIO
from reportlab.pdfgen import canvas
from reportlab.lib.pagesizes import A4
import os


# ================================================================
#  LOAD CSS PREMIUM
# ================================================================
css_path = "sabdatani.css"
if os.path.exists(css_path):
    with open(css_path) as f:
        st.markdown(f"<style>{f.read()}</style>", unsafe_allow_html=True)
else:
    st.warning("CSS file sabdatani.css tidak ditemukan.")


# ================================================================
#  LOAD DATA EXCEL (2 sheet)
# ================================================================
@st.cache_data
def load_excel():
    df_desa = pd.read_excel("penilaian kelas kelompok tani 2025 (2).xlsx", sheet_name="Data Desa")
    df_poktan = pd.read_excel("penilaian kelas kelompok tani 2025 (2).xlsx", sheet_name="Data Poktan List")
    return df_desa, df_poktan

df_desa, df_poktan = load_excel()


# ================================================================
#  REFORMAT DATA DESA
# ================================================================
df_long = df_desa.melt(id_vars=["Kecamatan"], var_name="Kolom", value_name="Desa")
df_long = df_long.dropna()
df_long = df_long[["Kecamatan", "Desa"]]


# ================================================================
#  REFORMAT DATA POKTAN LIST â†’ DESA, NAMA POKTAN
# ================================================================
poktan_list = []

for col in df_poktan.columns:
    desa_name = col.strip()
    for val in df_poktan[col].dropna():
        poktan_list.append({"Desa": desa_name, "Poktan": str(val).strip()})

df_poktan_long = pd.DataFrame(poktan_list)

df_merged = df_long.merge(df_poktan_long, on="Desa", how="left")

# Hapus poktan kosong
df_merged = df_merged.dropna(subset=["Poktan"])


# ================================================================
#  GEOCODER (Cache)
# ================================================================
@st.cache_data
def geocode_place(place):
    geolocator = Nominatim(user_agent="sabdatani")
    try:
        loc = geolocator.geocode(place + ", Pacitan, Jawa Timur, Indonesia")
        if loc:
            return loc.latitude, loc.longitude
    except:
        return None
    return None


# ================================================================
#  PDF GENERATOR (MULTI HALAMAN)
# ================================================================
def generate_pdf(df):
    buffer = BytesIO()
    p = canvas.Canvas(buffer, pagesize=A4)
    width, height = A4

    # Cover Page
    p.setFont("Helvetica-Bold", 22)
    p.drawString(80, height - 100, "LAPORAN DATA POKTAN SABDA TANI")
    p.setFont("Helvetica", 14)
    p.drawString(80, height - 130, "Kabupaten Pacitan â€“ 2025")

    p.showPage()

    # Per Kecamatan
    for kec in df["Kecamatan"].unique():
        sub = df[df["Kecamatan"] == kec]

        p.setFont("Helvetica-Bold", 18)
        p.drawString(50, height - 60, f"Kecamatan: {kec}")

        y = height - 100

        for _, row in sub.iterrows():
            p.setFont("Helvetica", 12)
            text = f"- Desa {row['Desa']}: {row['Poktan']}"
            p.drawString(60, y, text)
            y -= 18
            if y < 100:
                p.showPage()
                y = height - 60

        p.showPage()

    p.save()
    buffer.seek(0)

    return buffer


# ================================================================
#  SIDEBAR MENU
# ================================================================
st.sidebar.title("ðŸŒ¿ Sabda Tani Dashboard")
menu = st.sidebar.radio(
    "Navigasi",
    ["Dashboard Utama", "Peta GIS", "Data Poktan", "Export PDF"]
)


# ================================================================
#  DASHBOARD UTAMA
# ================================================================
if menu == "Dashboard Utama":
    st.title("ðŸŒ¾ Dashboard Sabda Tani â€“ Pacitan 2025")

    total_kec = df_long["Kecamatan"].nunique()
    total_desa = df_long["Desa"].nunique()
    total_poktan = df_poktan_long["Poktan"].nunique()

    col1, col2, col3 = st.columns(3)

    with col1:
        st.markdown('<div class="kpi-card"><h3>Total Kecamatan</h3><h1>' +
                    str(total_kec) + '</h1></div>', unsafe_allow_html=True)
    with col2:
        st.markdown('<div class="kpi-card"><h3>Total Desa</h3><h1>' +
                    str(total_desa) + '</h1></div>', unsafe_allow_html=True)
    with col3:
        st.markdown('<div class="kpi-card"><h3>Total Poktan</h3><h1>' +
                    str(total_poktan) + '</h1></div>', unsafe_allow_html=True)

    st.subheader("ðŸ“Š Distribusi Poktan per Kecamatan")
    df_count = df_merged.groupby("Kecamatan")["Poktan"].count().reset_index()
    df_count = df_count.rename(columns={"Poktan": "Jumlah Poktan"})

    fig = px.bar(df_count, x="Kecamatan", y="Jumlah Poktan",
                 color="Jumlah Poktan", color_continuous_scale="Greens",
                 title="Jumlah Poktan per Kecamatan")
    st.plotly_chart(fig, use_container_width=True)


# ================================================================
#  PETA GIS
# ================================================================
elif menu == "Peta GIS":
    st.title("ðŸ—º Peta GIS Sabda Tani")

    map_center = [-8.2045, 111.0874]
    m = folium.Map(location=map_center, zoom_start=11)

    marker_cluster = MarkerCluster().add_to(m)

    for _, row in df_merged.iterrows():
        loc = geocode_place(row["Desa"])
        if loc:
            folium.Marker(
                location=loc,
                tooltip=f"{row['Desa']} â€“ {row['Poktan']}",
                popup=f"<b>Desa:</b> {row['Desa']}<br><b>Poktan:</b> {row['Poktan']}"
            ).add_to(marker_cluster)

    st_folium(m, width=900, height=600)


# ================================================================
#  DATA POKTAN
# ================================================================
elif menu == "Data Poktan":
    st.title("ðŸ“‹ Data Poktan Sabda Tani")

    kec_select = st.selectbox("Pilih Kecamatan", df_merged["Kecamatan"].unique())
    desa_select = st.selectbox("Pilih Desa", df_merged[df_merged["Kecamatan"] == kec_select]["Desa"].unique())

    sub = df_merged[(df_merged["Kecamatan"] == kec_select) & (df_merged["Desa"] == desa_select)]

    st.dataframe(sub[["Desa", "Poktan"]])


# ================================================================
#  EXPORT PDF
# ================================================================
elif menu == "Export PDF":
    st.title("ðŸ“„ Export Laporan PDF")

    pdf_buffer = generate_pdf(df_merged)

    b64 = base64.b64encode(pdf_buffer.read()).decode()
    href = f'<a href="data:application/octet-stream;base64,{b64}" download="Laporan_SabdaTani.pdf">ðŸ“¥ Download PDF</a>'

    st.markdown(href, unsafe_allow_html=True)



