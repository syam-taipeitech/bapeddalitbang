# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1U6WD5A-bvWqPlW8_Z1xZ9QG9DkF00Q_s
"""
# ============================================
# SABDA TANI DASHBOARD ‚Äì FINAL PREMIUM VERSION
# Kecamatan ‚Üí Desa ‚Üí Gapoktan (Clean)
# ============================================

# -*- coding: utf-8 -*-
import streamlit as st
import pandas as pd
import plotly.express as px

# ================================
# LOAD CSS THEME
# ================================
with open("sabdatani.css") as f:
    st.markdown(f"<style>{f.read()}</style>", unsafe_allow_html=True)

st.set_page_config(page_title="Dashboard Sabda Tani ‚Äì Gapoktan", layout="wide")

# ================================
# LOAD DATA
# ================================
data1 = pd.read_excel("data1.xlsx")
data2 = pd.read_excel("data2.xlsx")

# ================================
# DETEKSI KOLOM data1 (kecamatan ‚Äì desa)
# ================================
kec_col = None
desa1_col = None

for c in data1.columns:
    name = c.lower().strip()
    if "kec" in name:
        kec_col = c
    if "desa" in name:
        desa1_col = c

if kec_col is None:
    st.error("‚ùå Tidak ditemukan kolom kecamatan di data1.xlsx")
    st.stop()

if desa1_col is None:
    st.error("‚ùå Tidak ditemukan kolom desa di data1.xlsx")
    st.stop()

# ================================
# DETEKSI KOLOM data2 (desa ‚Äì gapoktan)
# ================================
desa2_col = None
gap_col = None

for c in data2.columns:
    name = c.lower().strip()
    if "desa" in name:
        desa2_col = c
    if "gap" in name:
        gap_col = c

if desa2_col is None:
    st.error("‚ùå Tidak ditemukan kolom desa di data2.xlsx")
    st.stop()

if gap_col is None:
    st.error("‚ùå Tidak ditemukan kolom gapoktan di data2.xlsx")
    st.stop()

# ================================
# BERSIHKAN DATA
# ================================
data1[kec_col] = data1[kec_col].astype(str).str.strip()
data1[desa1_col] = data1[desa1_col].astype(str).str.strip()

data2[desa2_col] = data2[desa2_col].astype(str).str.strip()
data2[gap_col] = data2[gap_col].astype(str).str.strip()

# ================================
# MERGE data1 + data2
# ================================
merged = data1.merge(
    data2,
    left_on=desa1_col,
    right_on=desa2_col,
    how="left"
)

# ================================
# BANGUN HIERARKI (kecamatan ‚Üí desa ‚Üí gapoktan)
# ================================
data_hierarchy = {}

for _, row in merged.iterrows():
    kec = row[kec_col]
    desa = row[desa1_col]
    gap = row[gap_col]

    if kec not in data_hierarchy:
        data_hierarchy[kec] = {}

    if desa not in data_hierarchy[kec]:
        data_hierarchy[kec][desa] = []

    if pd.notna(gap):
        data_hierarchy[kec][desa].append(gap)


# ================================
# LIST KECAMATAN
# ================================
list_kecamatan_clean = sorted(list(data_hierarchy.keys()))


# ================================
# DASHBOARD HEADER
# ================================
st.markdown("""
<div class="title">
üåæ <span>Dashboard Sabda Tani ‚Äì Gapoktan</span>
</div>
""", unsafe_allow_html=True)


# ================================
# KPI SUMMARY
# ================================
total_kec = len(data_hierarchy)
total_desa = len(merged[desa_col].unique())
total_gapoktan = len(merged["gapoktan"].dropna().unique())

col1, col2, col3 = st.columns(3)

col1.markdown(f"""
<div class="card">
<h3>Total Kecamatan</h3>
<p>{total_kec}</p>
</div>
""", unsafe_allow_html=True)

col2.markdown(f"""
<div class="card">
<h3>Total Desa</h3>
<p>{total_desa}</p>
</div>
""", unsafe_allow_html=True)

col3.markdown(f"""
<div class="card">
<h3>Total Gapoktan</h3>
<p>{total_gapoktan}</p>
</div>
""", unsafe_allow_html=True)

st.markdown("<br>", unsafe_allow_html=True)


# ================================
# GRAFIK ‚Äì GAPOKTAN PER KECAMATAN
# ================================
st.markdown("### üìä Jumlah Gapoktan per Kecamatan")

chart_kec = []
for kec in data_hierarchy:
    jumlah_g = sum(len(g_list) for g_list in data_hierarchy[kec].values())
    chart_kec.append({"kecamatan": kec, "gapoktan": jumlah_g})

df_chart = pd.DataFrame(chart_kec)

fig = px.bar(
    df_chart,
    x="kecamatan",
    y="gapoktan",
    color="gapoktan",
    color_continuous_scale="Greens",
    title="Distribusi Gapoktan per Kecamatan"
)
st.plotly_chart(fig, use_container_width=True)


# ================================
# MENU INTERAKTIF
# ================================
st.markdown("### üîé Detail Gapoktan per Kecamatan & Desa")

c1, c2 = st.columns(2)

# PILIH KECAMATAN
kec_select = c1.selectbox(
    "Pilih Kecamatan",
    list_kecamatan_clean
)

# PILIH DESA
desa_list = sorted(list(data_hierarchy[kec_select].keys()))
desa_select = c2.selectbox(
    "Pilih Desa",
    desa_list
)

# TAMPILKAN GAPOKTAN
gapoktan_list = data_hierarchy[kec_select][desa_select]

st.markdown(f"### üå± Daftar Gapoktan ‚Äì **{desa_select}**")

if len(gapoktan_list) == 0:
    st.info("Tidak ada data gapoktan untuk desa ini.")
else:
    for g in gapoktan_list:
        st.markdown(f"- {g}")


