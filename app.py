# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1U6WD5A-bvWqPlW8_Z1xZ9QG9DkF00Q_s
"""
# ============================================
# SABDA TANI DASHBOARD â€“ FINAL PREMIUM VERSION
# Kecamatan â†’ Desa â†’ Gapoktan (Clean)
# ============================================

import streamlit as st
import pandas as pd
import plotly.express as px

# ================================
# LOAD CSS THEME
# ================================
with open("sabdatani.css") as f:
    st.markdown(f"<style>{f.read()}</style>", unsafe_allow_html=True)

st.set_page_config(page_title="Dashboard Sabda Tani â€“ Gapoktan", layout="wide")


# ================================
# LOAD DATA
# ================================
gapoktan_df = pd.read_excel("data1.xlsx")     # Desa â†’ Gapoktan
kec_desa_df = pd.read_csv("poktan_clean.csv") # Kecamatan â†’ Desa


# ================================
# PARSER: Desa â†’ Gapoktan
# ================================
def parse_gapoktan(df):
    result = {}
    for col in df.columns:
        desa = col.strip()
        items = df[col].dropna().astype(str).tolist()
        result[desa] = items
    return result

desa_gapoktan = parse_gapoktan(gapoktan_df)


# ================================
# PARSER: Kecamatan â†’ Desa â†’ Gapoktan
# ================================
def build_hierarchy(kec_desa_df, desa_gapoktan):
    hierarchy = {}

    for _, row in kec_desa_df.iterrows():
        kec = str(row["kecamatan"]).strip()
        desa = str(row["desa"]).strip()

        if kec not in hierarchy:
            hierarchy[kec] = {}

        # Jika desa ada di Excel â†’ ambil gapoktan
        if desa in desa_gapoktan:
            hierarchy[kec][desa] = desa_gapoktan[desa]
        else:
            hierarchy[kec][desa] = []   # tidak ada gapoktan

    return hierarchy

data_hierarchy = build_hierarchy(kec_desa_df, desa_gapoktan)


# ================================
# HEADER
# ================================
st.markdown("""
<div class="title">
ðŸŒ¾ <span>Dashboard Sabda Tani â€“ Gapoktan</span>
</div>
""", unsafe_allow_html=True)


# ================================
# KPI CARDS
# ================================
total_kec = len(data_hierarchy)
total_desa = len(desa_gapoktan)
total_gapoktan = sum(len(v) for v in desa_gapoktan.values())

col1, col2, col3 = st.columns(3)

col1.markdown(f"""
<div class="card"><h3>Total Kecamatan</h3><p>{total_kec}</p></div>
""", unsafe_allow_html=True)

col2.markdown(f"""
<div class="card"><h3>Total Desa</h3><p>{total_desa}</p></div>
""", unsafe_allow_html=True)

col3.markdown(f"""
<div class="card"><h3>Total Gapoktan</h3><p>{total_gapoktan}</p></div>
""", unsafe_allow_html=True)

st.markdown("<br>", unsafe_allow_html=True)


# ================================
# CHART â€“ Gapoktan per Kecamatan
# ================================
st.markdown("### ðŸ“Š Jumlah Gapoktan per Kecamatan")

df_chart = []
for kec, desa_dict in data_hierarchy.items():
    df_chart.append({
        "kecamatan": kec,
        "gapoktan": sum(len(g) for g in desa_dict.values())
    })

df_chart = pd.DataFrame(df_chart)

fig = px.bar(
    df_chart,
    x="kecamatan",
    y="gapoktan",
    color="gapoktan",
    color_continuous_scale="Greens",
    title="Distribusi Gapoktan per Kecamatan"
)
st.plotly_chart(fig, use_container_width=True)


# ================================
# INTERACTIVE MENU (PREMIUM GOLD)
# ================================

st.markdown("### ðŸ”Ž Detail Gapoktan per Kecamatan & Desa")

# --- Kolom Filter ---
c1, c2 = st.columns(2)

# Searchable dropdown kecamatan
kec_select = c1.selectbox(
    "Pilih Kecamatan",
    sorted(list_kecamatan_clean),
    index=None,
    placeholder="Cari kecamatan..."
)

# Validasi
if kec_select is None:
    st.info("Silakan pilih kecamatan untuk melihat data.")
    st.stop()

# Multiselect desa
desa_multiselect = c2.multiselect(
    "Pilih Desa (bisa lebih dari satu)",
    sorted(data_hierarchy[kec_select].keys()),
    placeholder="Pilih satu atau lebih desa..."
)

# Jika belum pilih desa â†’ fallback 1 desa default
if not desa_multiselect:
    desa_multiselect = [sorted(data_hierarchy[kec_select].keys())[0]]

# SUMMARY TOP
summary_total = sum(len(data_hierarchy[kec_select][d]) for d in desa_multiselect)

st.markdown(f"""
<div class="card-summary">
<h2>ðŸ“Š Total Gapoktan untuk Desa Terpilih</h2>
<p>{summary_total}</p>
</div>
""", unsafe_allow_html=True)

# CHART DESA
chart_desa = []
for d in data_hierarchy[kec_select]:
    chart_desa.append({"desa": d, "gapoktan": len(data_hierarchy[kec_select][d])})

fig_desa = px.bar(
    pd.DataFrame(chart_desa),
    x="desa",
    y="gapoktan",
    title=f"Distribusi Gapoktan per Desa â€“ Kecamatan {kec_select}",
    color="gapoktan",
    color_continuous_scale="YlGn"
)
st.plotly_chart(fig_desa, use_container_width=True)

# TABLE DETAIL
st.markdown("### ðŸ§© Tabel Gapoktan per Desa (Data Terpilih)")

table_data = []
for desa in desa_multiselect:
    for g in data_hierarchy[kec_select][desa]:
        table_data.append([desa, g])

df_table = pd.DataFrame(table_data, columns=["Desa", "Gapoktan"])
st.dataframe(df_table, use_container_width=True, hide_index=True)

# LIST GAPOKTAN PER DESA
for desa in desa_multiselect:
    st.markdown(f"### ðŸŒ± Daftar Gapoktan â€“ **{desa}**")
    for g in data_hierarchy[kec_select][desa]:
        st.markdown(f"- {g}")




