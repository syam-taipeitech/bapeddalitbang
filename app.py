# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1U6WD5A-bvWqPlW8_Z1xZ9QG9DkF00Q_s
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import folium
from streamlit_folium import st_folium
from folium.plugins import HeatMap, MarkerCluster
from geopy.geocoders import Nominatim
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Image, PageBreak, Table, TableStyle
from reportlab.lib.styles import getSampleStyleSheet
from reportlab.lib.pagesizes import A4
from reportlab.lib import colors
import plotly.io as pio
import uuid

# ============================
# LOAD CSS
# ============================
with open("sabdatani.css") as f:
    st.markdown(f"<style>{f.read()}</style>", unsafe_allow_html=True)

# ============================
# GEOCODER
# ============================
geolocator = Nominatim(user_agent="sabdatani")

@st.cache_data
def geo_address(address):
    try:
        loc = geolocator.geocode(f"{address}, Pacitan, Indonesia")
        if loc:
            return loc.latitude, loc.longitude
    except:
        return None
    return None

# ============================
# LOAD EXCEL (2-sheet parser)
# ============================
@st.cache_data
def load_excel(file):
    xls = pd.ExcelFile(file)

    # Sheet 1 = Kecamatan & Desa (ambil sheet pertama)
    df_kecdesa = pd.read_excel(file, sheet_name=xls.sheet_names[0], header=None)

    # Sheet 2 = Data Poktan List
    df_poktan = pd.read_excel(file, sheet_name="Data Poktan List")

    return df_kecdesa, df_poktan


# ============================
# PARSER: Kecamatan ‚Üí Desa
# ============================
def parse_kecamatan_desa(df):
    data = {}
    for idx, row in df.iterrows():
        if idx == 0:
            continue
        kec = str(row[0]).strip()
        if kec == "" or kec.lower() == "nan":
            continue

        desa_list = []
        for col in row[1:]:
            if pd.isna(col):
                continue
            desa_list.append(str(col).strip())

        data[kec] = desa_list
    return data


# ============================
# PARSER: Desa ‚Üí Poktan
# ============================
def parse_desa_poktan(df):
    desa_poktan = {}

    for col in df.columns:
        desa_name = col.strip()
        poktan_list = df[col].dropna().astype(str).tolist()
        desa_poktan[desa_name] = poktan_list

    return desa_poktan


# ============================
# BUILD MASTER STRUCTURE
# ============================
def build_structure(kec_desa, desa_poktan):
    structure = {}

    for kec, desa_list in kec_desa.items():
        structure[kec] = {}
        for desa in desa_list:
            if desa in desa_poktan:
                structure[kec][desa] = desa_poktan[desa]
            else:
                structure[kec][desa] = []
    return structure


# ============================
# CHART FUNCTIONS
# ============================
def chart_desa_per_kecamatan(df):
    fig = px.bar(
        df, x="Kecamatan", y="Jumlah Desa",
        color="Jumlah Desa", text="Jumlah Desa",
        color_continuous_scale="Greens",
        title="üìå Jumlah Desa per Kecamatan"
    )
    return fig

def chart_poktan_per_kecamatan(df):
    fig = px.bar(
        df, x="Kecamatan", y="Jumlah Poktan",
        color="Jumlah Poktan", text="Jumlah Poktan",
        color_continuous_scale="Greens",
        title="üåø Jumlah Poktan per Kecamatan"
    )
    return fig

def chart_poktan_per_desa(df):
    fig = px.bar(
        df, x="Desa", y="Jumlah Poktan",
        color="Jumlah Poktan", text="Jumlah Poktan",
        color_continuous_scale="Greens",
        title="üå± Poktan per Desa"
    )
    fig.update_xaxes(tickangle=45)
    return fig


# ============================
# GIS MAP ADVANCED
# ============================
def gis_advanced_map(data):
    m = folium.Map(location=[-8.2, 111.1], zoom_start=10, tiles="CartoDB positron")
    marker_cluster = MarkerCluster().add_to(m)
    heat_data = []

    for kec, desa_dict in data.items():
        for desa, poktans in desa_dict.items():
            coord = geo_address(desa)
            if coord:
                heat_data.append([coord[0], coord[1], len(poktans)])

                if len(poktans) >= 15:
                    color = "darkgreen"
                elif len(poktans) >= 8:
                    color = "green"
                else:
                    color = "lightgreen"

                folium.Marker(
                    coord,
                    popup=f"<b>{desa}</b><br>Kecamatan: {kec}<br>Poktan: {len(poktans)}",
                    icon=folium.Icon(color=color, icon="leaf")
                ).add_to(marker_cluster)

    HeatMap(heat_data, radius=25, blur=15).add_to(m)
    folium.LayerControl().add_to(m)
    return m


# ============================
# EXPORT PDF MULTI-HALAMAN
# ============================
def export_pdf_full(kec, desa, poktan_list, df_desa):
    filename = f"Laporan_{kec}_{desa}.pdf"
    styles = getSampleStyleSheet()
    doc = SimpleDocTemplate(filename, pagesize=A4)
    story = []

    # Cover
    story.append(Paragraph("<b><font size=24>SABDA TANI</font></b>", styles["Title"]))
    story.append(Paragraph("Laporan Kelembagaan Pertanian", styles["Heading2"]))
    story.append(Spacer(1, 20))
    story.append(Paragraph(f"Kecamatan: {kec}", styles["Normal"]))
    story.append(Paragraph(f"Desa: {desa}", styles["Normal"]))
    story.append(Paragraph(f"Jumlah Poktan: {len(poktan_list)}", styles["Normal"]))
    story.append(PageBreak())

    # Tabel Desa
    story.append(Paragraph("<b>Daftar Desa dan Jumlah Poktan</b>", styles["Heading2"]))
    table_data = [["Desa", "Jumlah Poktan"]] + df_desa.values.tolist()

    table = Table(table_data, colWidths=[200, 200])
    table.setStyle(TableStyle([
        ("BACKGROUND", (0,0), (-1,0), colors.lightgreen),
        ("GRID", (0,0), (-1,-1), 1, colors.grey),
    ]))
    story.append(table)
    story.append(PageBreak())

    # Poktan List
    story.append(Paragraph("<b>Daftar Poktan</b>", styles["Heading2"]))
    for p in poktan_list:
        story.append(Paragraph(f"- {p}", styles["Normal"]))
    story.append(PageBreak())

    # Rekomendasi
    story.append(Paragraph("<b>Rekomendasi</b>", styles["Heading2"]))
    story.append(Paragraph("""
    1. Penguatan kelembagaan desa sangat penting untuk stabilitas produksi.<br/>
    2. Perlu pembinaan berkelanjutan untuk poktan beranggotakan sedikit.<br/>
    3. Integrasikan sistem Sabda Tani untuk monitoring penyakit & NPK.<br/>
    """, styles["Normal"]))

    doc.build(story)
    return filename


# ============================
# STREAMLIT UI
# ============================
st.sidebar.title("üåæ Sabda Tani Dashboard")
uploaded = st.sidebar.file_uploader("Upload File Excel", type=["xlsx"])

menu = st.sidebar.radio("Menu",
    ["Dashboard Utama", "Kecamatan", "Desa", "Detail Poktan", "Treemap Hierarki", "Peta GIS", "Peta GIS Lanjutan", "Export PDF"]
)

if uploaded:
    df1, df2 = load_excel(uploaded)

    kec_desa = parse_kecamatan_desa(df1)
    desa_poktan = parse_desa_poktan(df2)
    data = build_structure(kec_desa, desa_poktan)

    if menu == "Dashboard Utama":
        st.title("üåø Dashboard Utama Sabda Tani")

        total_kec = len(data)
        total_desa = sum(len(v) for v in data.values())
        total_poktan = sum(len(vv) for v in data.values() for vv in v.values())

        c1, c2, c3 = st.columns(3)
        c1.metric("Total Kecamatan", total_kec)
        c2.metric("Total Desa", total_desa)
        c3.metric("Total Poktan", total_poktan)

        df_desa = pd.DataFrame(
            {"Kecamatan": list(kec_desa.keys()),
             "Jumlah Desa": [len(v) for v in kec_desa.values()]}
        )

        df_poktan = pd.DataFrame(
            {"Kecamatan": list(kec_desa.keys()),
             "Jumlah Poktan": [sum(len(data[k][d]) for d in data[k]) for k in data.keys()]}
        )

        st.plotly_chart(chart_desa_per_kecamatan(df_desa), use_container_width=True)
        st.plotly_chart(chart_poktan_per_kecamatan(df_poktan), use_container_width=True)

    elif menu == "Kecamatan":
        kec = st.selectbox("Pilih Kecamatan", list(data.keys()))
        st.subheader(f"Daftar Desa di {kec}")
        desa_list = list(data[kec].keys())
        st.write(desa_list)

        df = pd.DataFrame({"Desa": desa_list, "Jumlah Poktan": [len(data[kec][d]) for d in desa_list]})
        st.plotly_chart(chart_poktan_per_desa(df), use_container_width=True)

    elif menu == "Desa":
        kec = st.selectbox("Pilih Kecamatan", list(data.keys()))
        desa = st.selectbox("Pilih Desa", list(data[kec].keys()))
        st.write(data[kec][desa])

    elif menu == "Peta GIS":
        st.title("üó∫Ô∏è Peta GIS")
        m = folium.Map(location=[-8.2, 111.1], zoom_start=10)
        for kec, desa_dict in data.items():
            for desa in desa_dict:
                coord = geo_address(desa)
                if coord:
                    folium.Marker(coord, popup=desa).add_to(m)
        st_folium(m, width=900)

    elif menu == "Peta GIS Lanjutan":
        st.title("üó∫Ô∏è Peta GIS Lanjutan ‚Äì Sabda Tani Geo-Intelligence")
        m = gis_advanced_map(data)
        st_folium(m, width=900, height=600)

    elif menu == "Export PDF":
        kec = st.selectbox("Pilih Kecamatan", list(data.keys()))
        desa = st.selectbox("Pilih Desa", list(data[kec].keys()))
        poktan_list = data[kec][desa]

        df_desa = pd.DataFrame(
            {"Desa": list(data[kec].keys()), "Jumlah Poktan": [len(data[kec][d]) for d in data[kec].keys()]}
        )

        if st.button("Generate PDF"):
            pdf = export_pdf_full(kec, desa, poktan_list, df_desa)
            with open(pdf, "rb") as f:
                st.download_button("Download PDF", f, file_name=pdf)

else:
    st.info("Upload file Excel terlebih dahulu.")


