# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1U6WD5A-bvWqPlW8_Z1xZ9QG9DkF00Q_s
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import base64
import os
from io import BytesIO
from reportlab.pdfgen import canvas
from reportlab.lib.pagesizes import A4


# ================================================================
#  LOAD CSS PREMIUM
# ================================================================
css_path = "sabdatani.css"
if os.path.exists(css_path):
    with open(css_path) as f:
        st.markdown(f"<style>{f.read()}</style>", unsafe_allow_html=True)
else:
    st.warning("‚ö† File sabdatani.css tidak ditemukan.")


# ================================================================
#  LOAD EXCEL DATA
# ================================================================
@st.cache_data
def load_data():
    df_raw = pd.read_excel("data1.xlsx")
    return df_raw

df_raw = load_data()


# ================================================================
#  PARSER KECAMATAN ‚Üí DESA ‚Üí GAPOKTAN
# ================================================================
def parse_kecamatan_desa_gapoktan(df):
    rows = []

    for i, row in df.iterrows():
        kecamatan = str(row.iloc[0]).strip()          # kolom A
        desa_cols = row.iloc[1:13]                    # kolom B-M (12 kolom)
        gapoktan_cols = row.iloc[13:]                 # kolom N-GC (semua gapoktan)

        desa_list = [str(d).strip() for d in desa_cols if pd.notna(d) and str(d).strip() != ""]
        gapoktan_list = [str(g).strip() for g in gapoktan_cols if pd.notna(g) and str(g).strip() != ""]

        for idx, desa in enumerate(desa_list):
            if idx < len(gapoktan_list):
                rows.append({
                    "Kecamatan": kecamatan,
                    "Desa": desa,
                    "Gapoktan": gapoktan_list[idx]
                })
            else:
                rows.append({
                    "Kecamatan": kecamatan,
                    "Desa": desa,
                    "Gapoktan": None
                })

    return pd.DataFrame(rows)


df_final = parse_kecamatan_desa_gapoktan(df_raw)


# ================================================================
#  PDF GENERATOR
# ================================================================
def generate_pdf(df):
    buffer = BytesIO()
    p = canvas.Canvas(buffer, pagesize=A4)
    width, height = A4

    p.setFont("Helvetica-Bold", 22)
    p.drawString(70, height - 70, "LAPORAN GAPOKTAN SABDA TANI ‚Äì PACITAN")
    p.setFont("Helvetica", 14)
    p.drawString(70, height - 100, "Data Kecamatan ‚Üí Desa ‚Üí Gapoktan")

    p.showPage()

    for kec in df["Kecamatan"].unique():
        sub = df[df["Kecamatan"] == kec]

        p.setFont("Helvetica-Bold", 18)
        p.drawString(60, height - 60, f"Kecamatan: {kec}")

        y = height - 100
        for _, row in sub.iterrows():
            p.setFont("Helvetica", 12)
            text = f"- {row['Desa']} : {row['Gapoktan']}"
            p.drawString(80, y, text)
            y -= 18

            if y < 60:
                p.showPage()
                y = height - 60

        p.showPage()

    p.save()
    buffer.seek(0)
    return buffer


# ================================================================
#  SIDEBAR MENU
# ================================================================
st.sidebar.title("üåø Sabda Tani Dashboard")
menu = st.sidebar.radio(
    "Navigasi",
    [
        "Dashboard Utama",
        "Detail Per Kecamatan",
        "Data Gapoktan",
        "Export PDF"
    ]
)

# ================================================================
#  DASHBOARD UTAMA
# ================================================================
if menu == "Dashboard Utama":
    st.title("üåæ Dashboard Sabda Tani ‚Äì Gapoktan Pacitan")

    total_kec = df_final["Kecamatan"].nunique()
    total_desa = df_final["Desa"].nunique()
    total_gapo = df_final["Gapoktan"].nunique()

    c1, c2, c3 = st.columns(3)
    c1.markdown(f'<div class="kpi-card"><h3>Total Kecamatan</h3><h1>{total_kec}</h1></div>', unsafe_allow_html=True)
    c2.markdown(f'<div class="kpi-card"><h3>Total Desa</h3><h1>{total_desa}</h1></div>', unsafe_allow_html=True)
    c3.markdown(f'<div class="kpi-card"><h3>Total Gapoktan</h3><h1>{total_gapo}</h1></div>', unsafe_allow_html=True)

    st.subheader("üìä Jumlah Gapoktan per Kecamatan")

    df_count = df_final.groupby("Kecamatan")["Gapoktan"].count().reset_index()
    fig = px.bar(df_count, x="Kecamatan", y="Gapoktan",
                 color="Gapoktan", color_continuous_scale="Greens",
                 title="Distribusi Gapoktan per Kecamatan")
    st.plotly_chart(fig, use_container_width=True)

# ================================================================
#  DASHBOARD DETAIL (PER KECAMATAN ‚Üí DESA ‚Üí GAPOKTAN)
# ================================================================
elif menu == "Detail Per Kecamatan":
    st.title("üìç Detail Kecamatan ‚Üí Desa ‚Üí Gapoktan")

    # Pilih Kecamatan
    kec_select = st.selectbox("Pilih Kecamatan", df_final["Kecamatan"].unique())

    # Filter desa berdasarkan kecamatan
    desa_list = df_final[df_final["Kecamatan"] == kec_select]["Desa"].unique()
    desa_select = st.selectbox("Pilih Desa", desa_list)

    # Tampilkan gapoktan per desa
    hasil = df_final[
        (df_final["Kecamatan"] == kec_select) &
        (df_final["Desa"] == desa_select)
    ]

    st.subheader(f"üìå Gapoktan di Desa {desa_select}")
    st.dataframe(hasil[["Gapoktan"]])

    # Kartu / Card
    for _, row in hasil.iterrows():
        st.markdown(
            f"""
            <div class='kpi-card'>
                <h3>{row['Gapoktan']}</h3>
            </div>
            """,
            unsafe_allow_html=True
        )

    # Grafik batang per desa
    st.subheader("üìä Grafik Jumlah Gapoktan per Desa (Hanya Desa Terpilih)")

    fig = px.bar(
        hasil,
        x="Desa",
        y=[1] * len(hasil),  # karena per desa jumlah gapoktan = n baris
        title=f"Jumlah Gapoktan di {desa_select}",
        labels={"y": "Jumlah Gapoktan"},
        color_discrete_sequence=["#16a34a"]
    )
    st.plotly_chart(fig, use_container_width=True)


# ================================================================
#  DATA GAPOKTAN
# ================================================================
elif menu == "Data Gapoktan":
    st.title("üìã Data Gapoktan per Desa")

    kec_select = st.selectbox("Pilih Kecamatan", df_final["Kecamatan"].unique())
    desa_select = st.selectbox("Pilih Desa", df_final[df_final["Kecamatan"] == kec_select]["Desa"].unique())

    sub = df_final[(df_final["Kecamatan"] == kec_select) & (df_final["Desa"] == desa_select)]

    st.dataframe(sub)



# ================================================================
#  EXPORT PDF
# ================================================================
elif menu == "Export PDF":
    st.title("üìÑ Export Laporan Gapoktan")

    pdf_buffer = generate_pdf(df_final)
    b64 = base64.b64encode(pdf_buffer.read()).decode()
    link = f'<a href="data:application/octet-stream;base64,{b64}" download="Laporan_Gapoktan_SabdaTani.pdf">üì• Download PDF</a>'

    st.markdown(link, unsafe_allow_html=True)



