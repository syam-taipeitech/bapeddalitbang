# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1U6WD5A-bvWqPlW8_Z1xZ9QG9DkF00Q_s
"""

import streamlit as st
import pandas as pd
import plotly.express as px

# ======================================================
# LOAD DATA
# ======================================================
@st.cache_data
def load_data():
    df = pd.read_csv("poktan_clean.csv")

    # pastikan kolom lowercase
    df.columns = df.columns.str.lower()

    # nama kolom wajib: kecamatan, desa, nama_poktan
    return df

df = load_data()

# ======================================================
# GENERATE LIST POKTAN (Kecamatan -> Desa -> Poktan)
# ======================================================
def generate_poktan_list(df):
    poktan_dict = {}

    for _, row in df.iterrows():
        kec = row["kecamatan"]
        desa = row["desa"]
        poktan = row["nama_poktan"]

        if kec not in poktan_dict:
            poktan_dict[kec] = {}

        if desa not in poktan_dict[kec]:
            poktan_dict[kec][desa] = []

        if poktan not in poktan_dict[kec][desa]:
            poktan_dict[kec][desa].append(poktan)

    return poktan_dict

poktan_list = generate_poktan_list(df)

# ======================================================
# SIDEBAR MENU
# ======================================================
menu = st.sidebar.selectbox(
    "Pilih Menu",
    [
        "Dashboard Utama",
        "Poktan per Kecamatan",
        "Poktan per Desa",
        "Detail Poktan"
    ]
)

# ======================================================
# HALAMAN 1 â€” DASHBOARD UTAMA
# ======================================================
if menu == "Dashboard Utama":
    st.title("ğŸ“Š Dashboard Data Poktan Kabupaten Pacitan")

    total_kec = df["kecamatan"].nunique()
    total_desa = df["desa"].nunique()
    total_poktan = df["nama_poktan"].nunique()

    col1, col2, col3 = st.columns(3)
    col1.metric("Total Kecamatan", total_kec)
    col2.metric("Total Desa", total_desa)
    col3.metric("Total Poktan", total_poktan)

    # Grafik Poktan per Kecamatan
    per_kec = df.groupby("kecamatan").size().reset_index(name="jumlah")
    fig = px.bar(
        per_kec,
        x="kecamatan",
        y="jumlah",
        title="ğŸ“Œ Jumlah Poktan per Kecamatan",
        text="jumlah",
    )
    st.plotly_chart(fig, use_container_width=True)

# ======================================================
# HALAMAN 2 â€” Poktan per Kecamatan
# ======================================================
elif menu == "Poktan per Kecamatan":
    st.title("ğŸï¸ Poktan per Kecamatan")

    kec_list = list(poktan_list.keys())
    kec_select = st.selectbox("Pilih Kecamatan", kec_list)

    per_desa = (
        df[df["kecamatan"] == kec_select]
        .groupby("desa")
        .size()
        .reset_index(name="jumlah")
    )

    fig = px.bar(
        per_desa,
        x="desa",
        y="jumlah",
        text="jumlah",
        title=f"Jumlah Poktan per Desa â€“ {kec_select}"
    )
    st.plotly_chart(fig, use_container_width=True)

    st.subheader("ğŸ“ Data Desa")
    st.dataframe(per_desa)

# ======================================================
# HALAMAN 3 â€” Poktan per Desa (Dropdown Kecamatan â†’ Desa)
# ======================================================
elif menu == "Poktan per Desa":
    st.title("ğŸ˜ï¸ Poktan per Desa")

    kec_select = st.selectbox("Pilih Kecamatan", list(poktan_list.keys()))
    desa_select = st.selectbox("Pilih Desa", list(poktan_list[kec_select].keys()))

    filtered = df[
        (df["kecamatan"] == kec_select)
        & (df["desa"] == desa_select)
    ]

    st.subheader(f"ğŸ“‹ Daftar Poktan â€“ {desa_select}")
    st.dataframe(filtered[["nama_poktan"]])

    fig = px.bar(
        filtered,
        x="nama_poktan",
        y="nama_poktan",
        title=f"Jumlah Poktan di Desa {desa_select}",
        labels={"nama_poktan": "Nama Poktan"},
    )
    st.plotly_chart(fig, use_container_width=True)

# ======================================================
# HALAMAN 4 â€” DETAIL POKTAN (Kecamatan â†’ Desa â†’ Poktan)
# ======================================================
elif menu == "Detail Poktan":
    st.title("ğŸ” Detail Poktan")

    kec_select = st.selectbox("Pilih Kecamatan", list(poktan_list.keys()))
    desa_select = st.selectbox("Pilih Desa", list(poktan_list[kec_select].keys()))
    poktan_select = st.selectbox("Pilih Poktan", poktan_list[kec_select][desa_select])

    detail = df[
        (df["kecamatan"] == kec_select)
        & (df["desa"] == desa_select)
        & (df["nama_poktan"] == poktan_select)
    ]

    st.subheader(f"ğŸ“Œ Detail Poktan: {poktan_select}")
    st.dataframe(detail)

    st.info("Jika ingin fitur tambahan (peta, galeri, penilaian poktan, dsb), tinggal bilang ya Syam ğŸ™Œ")

