# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1U6WD5A-bvWqPlW8_Z1xZ9QG9DkF00Q_s
"""

import streamlit as st
import pandas as pd
import plotly.express as px

st.set_page_config(page_title="Dashboard Poktan Pacitan", layout="wide")

# ===========================
# LOAD DATA
# ===========================
@st.cache_data
def load_data():
    df = pd.read_csv("poktan_clean.csv")
    df["tipe"] = df["nama_poktan"].apply(
        lambda x: "KWT" if "kwt" in str(x).lower() else "Poktan"
    )
    return df

df = load_data()


# ===========================
# SIDEBAR MENU
# ===========================
menu = st.sidebar.selectbox(
    "Pilih Menu Visualisasi",
    [
        "Dashboard Utama",
        "Poktan per Kecamatan",
        "Poktan per Desa",
        "Top Desa Teraktif",
        "KWT vs Poktan",
        "Tabel Data"
    ]
)

st.sidebar.info("Dashboard Kelembagaan Pertanian ‚Äî Sabda Tani 2025")
st.sidebar.write("Data dari poktan_clean.csv")


# ===========================
# HALAMAN ‚Äì DASHBOARD UTAMA
# ===========================
if menu == "Dashboard Utama":
    st.title("üìä Dashboard Kelembagaan Poktan Kabupaten Pacitan")

    col1, col2, col3, col4 = st.columns(4)
    col1.metric("Total Kecamatan", df["kecamatan"].nunique())
    col2.metric("Total Desa", df["desa"].nunique())
    col3.metric("Total Poktan", df.shape[0])
    col4.metric("Total KWT", df[df["tipe"]=="KWT"].shape[0])

    per_kec = df.groupby("kecamatan").size().reset_index(name="jumlah_poktan")
    fig = px.bar(per_kec, x="kecamatan", y="jumlah_poktan",
                 title="Jumlah Poktan per Kecamatan",
                 color="jumlah_poktan", text="jumlah_poktan")
    st.plotly_chart(fig, use_container_width=True)


# ===========================
# HALAMAN ‚Äì PER KECAMATAN
# ===========================
elif menu == "Poktan per Kecamatan":
    st.title("üìç Poktan per Kecamatan")

    per_kec = df.groupby("kecamatan").size().reset_index(name="jumlah_poktan")
    fig = px.bar(per_kec, x="kecamatan", y="jumlah_poktan",
                 color="jumlah_poktan", text="jumlah_poktan")
    st.plotly_chart(fig, use_container_width=True)


# ===========================
# HALAMAN ‚Äì PER DESA
# ===========================
elif menu == "Poktan per Desa":
    st.title("üèòÔ∏è Poktan per Desa")

    per_desa = df.groupby(["kecamatan", "desa"]).size().reset_index(name="jumlah_poktan")
    kec_list = per_desa["kecamatan"].unique()
    kec_select = st.selectbox("Pilih Kecamatan", kec_list)

    filtered = per_desa[per_desa["kecamatan"] == kec_select]

    fig = px.bar(filtered, x="desa", y="jumlah_poktan",
                 title=f"Jumlah Poktan Desa ‚Äì {kec_select}",
                 text="jumlah_poktan")
    st.plotly_chart(fig, use_container_width=True)


# ===========================
# HALAMAN ‚Äì TOP DESA
# ===========================
elif menu == "Top Desa Teraktif":
    st.title("üî• Top Desa dengan Poktan Terbanyak")

    per_desa = df.groupby(["kecamatan", "desa"]).size().reset_index(name="jumlah_poktan")
    top_desa = per_desa.sort_values("jumlah_poktan", ascending=False).head(15)

    fig = px.bar(top_desa, x="jumlah_poktan", y="desa",
                 orientation="h",
                 color="jumlah_poktan",
                 title="Top 15 Desa Paling Aktif")
    st.plotly_chart(fig, use_container_width=True)


# ===========================
# HALAMAN ‚Äì KWT VS POKTAN
# ===========================
elif menu == "KWT vs Poktan":
    st.title("üåæ Komposisi KWT vs Poktan")

    counts = df["tipe"].value_counts().reset_index()
    counts.columns = ["tipe", "jumlah"]
    fig = px.pie(counts, names="tipe", values="jumlah")
    st.plotly_chart(fig, use_container_width=True)


# ===========================
# HALAMAN ‚Äì TABEL DATA
# ===========================
elif menu == "Tabel Data":
    st.title("üìã Data Lengkap Kelompok Tani")
    st.dataframe(df)